apiVersion: batch/v1
kind: Job
metadata:
  generateName: schema-migrate-
  annotations:
    argocd.argoproj.io/hook: PreSync
spec:
  template:
    metadata:
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      containers:
      - name: presync-job
        image: alpine:latest
        env:
        - name: condition
          value: "true"
        command:
        - /bin/sh
        - -c
        - >
          print_something () {
            apk update && apk add --no-cache curl bash && apk add jq
            echo "Hello I am a function"
            que_url=$(curl -i -H 'Accept: application/json' http://34.100.140.136:8080/job/slack_notif/build?token=token123 --user gangadhar:11e616607d1ca4ca1d264d2d645780ad22 | grep Location | awk '{print $2}')
            que_url="${que_url}api/json?pretty=true"
            job_url_jobid="null"
            while [ "$job_url_jobid" = "null" ]; do job_url_jobid=`curl $que_url --user gangadhar:11e616607d1ca4ca1d264d2d645780ad22 | jq -r '.executable.url'`; sleep 5s; done
            echo "$job_url_jobid"
            job_url_jobid="${job_url_jobid}api/json?pretty=true"
            result="null"
            while [ "$result" = "null" ]; do result=`curl $job_url_jobid --user gangadhar:11e616607d1ca4ca1d264d2d645780ad22 | jq -r '.result'`; sleep 5s; done
            echo "JOB STATUS: $result"
            } && print_something
      restartPolicy: OnFailure
  backoffLimit: 4
